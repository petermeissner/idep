
<!DOCTYPE html>
<html>
<head>
<style type="text/css">
.knitr .inline {
  background-color: #f7f7f7;
  border:solid 1px #B0B0B0;
}
.error {
	font-weight: bold;
	color: #FF0000;
}
.warning {
	font-weight: bold;
}
.message {
	font-style: italic;
}
.source, .output, .warning, .error, .message {
	padding: 0 1em;
  border:solid 1px #F7F7F7;
}
.source {
  background-color: #f5f5f5;
}
.rimage .left {
  text-align: left;
}
.rimage .right {
  text-align: right;
}
.rimage .center {
  text-align: center;
}
.hl.num {
  color: #AF0F91;
}
.hl.str {
  color: #317ECC;
}
.hl.com {
  color: #AD95AF;
  font-style: italic;
}
.hl.opt {
  color: #000000;
}
.hl.std {
  color: #585858;
}
.hl.kwa {
  color: #295F94;
  font-weight: bold;
}
.hl.kwb {
  color: #B05A65;
}
.hl.kwc {
  color: #55aa55;
}
.hl.kwd {
  color: #BC5A65;
  font-weight: bold;
}
</style>
  <script src="http://yihui.name/media/js/center-images.js"></script>
  <title>A Report Generated by knitr</title>
</head>
<body>

  <p>This report is automatically generated with the R
    package <a href="http://yihui.name/knitr"><strong>knitr</strong></a>
    (version <code class="knitr inline">1.10.5</code>)
    .</p>

<div class="chunk" id="auto-report"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl com"># script for downloading newest data from database and saving it to disk</span>

<span class="hl com"># setting things up</span>
<span class="hl kwd">library</span><span class="hl std">(idep)</span>
<span class="hl kwd">library</span><span class="hl std">(foreign)</span>
<span class="hl kwd">library</span><span class="hl std">(stringr)</span>
<span class="hl kwd">library</span><span class="hl std">(magrittr)</span>
<span class="hl kwd">library</span><span class="hl std">(RMySQL)</span>
</pre></div>
<div class="message"><pre class="knitr r">## Loading required package: DBI
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com"># set dev options / unless provided by commandline arguments</span>
<span class="hl kwd">eval_cl_args</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">##  [1] &quot;C:\\PROGRA~1\\R\\R-32~1.1\\bin\\x64\\Rterm.exe&quot;          
##  [2] &quot;--slave&quot;                                                 
##  [3] &quot;--no-restore&quot;                                            
##  [4] &quot;-e&quot;                                                      
##  [5] &quot;library(knitr);knitr::stitch_rhtml(commandArgs(TRUE)[1])&quot;
##  [6] &quot;--args&quot;                                                  
##  [7] &quot;get_newest_data_from_db.R&quot;                               
##  [8] &quot;--vanilla&quot;                                               
##  [9] &quot;--args&quot;                                                  
## [10] &quot;UPDATE_TEXTS=FALSE&quot;
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl kwd">if_not_exists</span><span class="hl std">(DEV,</span> <span class="hl num">FALSE</span><span class="hl std">)</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] TRUE
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl kwd">if_not_exists</span><span class="hl std">(UPDATE_TEXTS,</span> <span class="hl num">FALSE</span><span class="hl std">)</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] FALSE
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl std">get_ready</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">function</span><span class="hl std">(){</span>
  <span class="hl kwd">lapply</span><span class="hl std">(</span> <span class="hl kwd">dbListConnections</span><span class="hl std">(</span> <span class="hl kwd">dbDriver</span><span class="hl std">(</span> <span class="hl kwc">drv</span> <span class="hl std">=</span> <span class="hl str">&quot;MySQL&quot;</span><span class="hl std">)), dbDisconnect)</span>
  <span class="hl kwd">source</span><span class="hl std">(</span><span class="hl str">&quot;~/DBConnections/so_local.r&quot;</span><span class="hl std">)</span>
  <span class="hl com">#source(&quot;~/DBConnections/so_latin1_local.r&quot;)</span>
  <span class="hl com">#source(&quot;~/DBConnections/DBSOconnection.r&quot;)</span>
<span class="hl std">}</span>

<span class="hl kwd">get_ready</span><span class="hl std">()</span> <span class="hl com"># 1 = local utf8</span>
</pre></div>
<div class="message"><pre class="knitr r">## socon: Local DB - UTF-8
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl std">`%.%`</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">a</span><span class="hl std">,</span><span class="hl kwc">b</span><span class="hl std">)</span> <span class="hl kwd">paste0</span><span class="hl std">(a,b)</span>

<span class="hl com"># set WD</span>
<span class="hl kwa">if</span> <span class="hl std">( DEV ){</span>
  <span class="hl std">path</span> <span class="hl kwb">=</span> <span class="hl str">&quot;~/../CodingData&quot;</span>
  <span class="hl kwd">dir.create</span><span class="hl std">(path,</span> <span class="hl kwc">showWarnings</span> <span class="hl std">= F)</span>
  <span class="hl kwd">setwd</span><span class="hl std">(path)</span>
<span class="hl std">}</span><span class="hl kwa">else</span><span class="hl std">{</span>
  <span class="hl kwd">setwd</span><span class="hl std">(</span><span class="hl str">&quot;Z:/Gesch\u00e4ftsordnungen/database/extracts&quot;</span><span class="hl std">)</span>
<span class="hl std">}</span>
<span class="hl kwd">getwd</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] &quot;Z:/Geschäftsordnungen/database/extracts&quot;
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com"># connection info</span>
<span class="hl std">socon</span>
</pre></div>
<div class="output"><pre class="knitr r">## &lt;MySQLConnection:0,0&gt;
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com"># listing tables</span>
<span class="hl kwd">dbListTables</span><span class="hl std">(socon)</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] &quot;data_linelinkage&quot;                 &quot;data_textlines&quot;                  
## [3] &quot;data_texts&quot;                       &quot;metachange&quot;                      
## [5] &quot;sources&quot;                          &quot;temp_linelinkage_textlines_texts&quot;
## [7] &quot;tsebelis&quot;                         &quot;version&quot;                         
## [9] &quot;view_last_update&quot;
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl kwd">get_table_info</span><span class="hl std">(socon)</span>
</pre></div>
<div class="output"><pre class="knitr r">##                                    rows columns
## data_linelinkage                   6679      17
## data_textlines                    11044      11
## data_texts                           14       9
## metachange                          796      38
## sources                              73      12
## temp_linelinkage_textlines_texts 387398      50
## tsebelis                             18      14
## version                             206       6
## view_last_update                     21       1
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com"># version check </span>
<span class="hl std">file_version</span> <span class="hl kwb">&lt;-</span>
  <span class="hl kwd">str_extract</span><span class="hl std">(</span><span class="hl kwd">list.files</span><span class="hl std">(),</span> <span class="hl str">&quot;\\d+\\.\\d+&quot;</span><span class="hl std">)</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">as.numeric</span><span class="hl std">()</span>  <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">max</span><span class="hl std">(</span><span class="hl kwc">na.rm</span><span class="hl std">=T)</span>
<span class="hl std">file_version</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] 1.72
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl std">db_version</span>   <span class="hl kwb">&lt;-</span>
  <span class="hl kwd">dbReadTable</span><span class="hl std">(socon,</span> <span class="hl str">&quot;version&quot;</span><span class="hl std">)</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">select</span><span class="hl std">(versionnumber)</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">unlist</span><span class="hl std">()</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">as.numeric</span><span class="hl std">()</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">max</span><span class="hl std">(</span><span class="hl kwc">na.rm</span><span class="hl std">=T)</span>
<span class="hl std">db_version</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] 1.73
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl std">files_need_update</span> <span class="hl kwb">&lt;-</span> <span class="hl std">db_version</span> <span class="hl opt">&gt;</span> <span class="hl std">file_version</span>
<span class="hl std">files_need_update</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] TRUE
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com">### data on changes / linelinkage ###</span>
<span class="hl std">ll_view</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">download_linelinkage_view</span><span class="hl std">( socon,</span> <span class="hl kwc">saveToFile</span><span class="hl std">=files_need_update)</span>  <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">as_data_frame</span><span class="hl std">()</span>
</pre></div>
<div class="message"><pre class="knitr r">## downloading data ... 
## 6.06 sec
## 
## saving data ...
## 17.83 sec
## 29.05 sec
## done, info wirtten to:
## Z:/Geschäftsordnungen/database/extracts/view_linelinkage_db_version_1.73.Rdata
## Z:/Geschäftsordnungen/database/extracts/view_linelinkage_db_version_1.73.dta
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com">### raw data</span>
<span class="hl std">ll_raw</span>  <span class="hl kwb">&lt;-</span>
  <span class="hl kwd">download_linelinkage_raw</span><span class="hl std">( socon,</span> <span class="hl kwc">saveToFile</span><span class="hl std">=files_need_update)</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">as_data_frame</span><span class="hl std">()</span>
</pre></div>
<div class="message"><pre class="knitr r">## downloading data ... 
## 0.0300000000000011 sec
## 
## saving data ...
## 0.0499999999999972 sec
## 0.169999999999987 sec
## done, info wirtten to:
## Z:/Geschäftsordnungen/database/extracts/raw_linelinkage_db_version_1.73.Rdata
## Z:/Geschäftsordnungen/database/extracts/raw_linelinkage_db_version_1.73.dta
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl std">t_raw</span>   <span class="hl kwb">&lt;-</span>
  <span class="hl kwd">download_texts_raw</span><span class="hl std">( socon,</span> <span class="hl kwc">saveToFile</span><span class="hl std">=files_need_update)</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">as_data_frame</span><span class="hl std">()</span>
</pre></div>
<div class="message"><pre class="knitr r">## downloading data ... 
## 0 sec
## 
## saving data ...
## 0 sec
## 0.0300000000000011 sec
## done, info wirtten to:
## Z:/Geschäftsordnungen/database/extracts/raw_texts_db_version_1.73.Rdata
## Z:/Geschäftsordnungen/database/extracts/raw_texts_db_version_1.73.dta
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl std">tl_raw</span>  <span class="hl kwb">&lt;-</span> <span class="hl kwd">download_textlines_raw</span><span class="hl std">( socon,</span> <span class="hl kwc">saveToFile</span><span class="hl std">=files_need_update)</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">as_data_frame</span><span class="hl std">()</span>
</pre></div>
<div class="message"><pre class="knitr r">## downloading data ... 
## 0.0499999999999972 sec
## 
## saving data ...
## 0.200000000000003 sec
## 0.169999999999987 sec
## done, info wirtten to:
## Z:/Geschäftsordnungen/database/extracts/raw_textlines_db_version_1.73.Rdata
## Z:/Geschäftsordnungen/database/extracts/raw_textlines_db_version_1.73.dta
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com">### moving old files to trash</span>
<span class="hl kwd">file.move</span><span class="hl std">(</span>
  <span class="hl kwd">grep</span><span class="hl std">(db_version,</span> <span class="hl kwd">list.files</span><span class="hl std">(),</span> <span class="hl kwc">value</span><span class="hl std">=T,</span> <span class="hl kwc">invert</span> <span class="hl std">= T),</span>
  <span class="hl kwa">if</span><span class="hl std">(</span>
    <span class="hl kwd">length</span><span class="hl std">(</span><span class="hl kwd">grep</span><span class="hl std">(db_version,</span> <span class="hl kwd">list.files</span><span class="hl std">(),</span> <span class="hl kwc">value</span><span class="hl std">=T,</span> <span class="hl kwc">invert</span> <span class="hl std">= T))</span><span class="hl opt">&gt;</span><span class="hl num">0</span>
  <span class="hl std">){</span>
    <span class="hl str">&quot;../trash&quot;</span>
  <span class="hl std">}</span><span class="hl kwa">else</span><span class="hl std">{</span>
    <span class="hl kwa">NULL</span>
  <span class="hl std">}</span>
<span class="hl std">)</span>
</pre></div>
<div class="output"><pre class="knitr r">##         raw_linelinkage_db_version_1.72.dta       raw_linelinkage_db_version_1.72.Rdata 
##                                        TRUE                                        TRUE 
##           raw_textlines_db_version_1.72.dta         raw_textlines_db_version_1.72.Rdata 
##                                        TRUE                                        TRUE 
##               raw_texts_db_version_1.72.dta             raw_texts_db_version_1.72.Rdata 
##                                        TRUE                                        TRUE 
##        view_linelinkage_db_version_1.72.dta      view_linelinkage_db_version_1.72.Rdata 
##                                        TRUE                                        TRUE 
## view_linelinkage_db_version_README_1.72.txt 
##                                        TRUE
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com"># wirting texts and linkages into need litle HTML files to be looked upon</span>
<span class="hl com">## &gt;&gt; UPDATE_TEXTS==TRUE</span>
<span class="hl kwa">if</span><span class="hl std">( UPDATE_TEXTS )</span>
<span class="hl std">{</span>
  <span class="hl kwd">setwd</span><span class="hl std">(</span><span class="hl str">&quot;Z:/Gesch\u00e4ftsordnungen/database/outputs/text_and_corpus&quot;</span><span class="hl std">)</span>

  <span class="hl com">### &gt;&gt; producing texts # -------------------------------------------------------</span>
  <span class="hl std">`%.%`</span> <span class="hl kwb">&lt;-</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">a</span><span class="hl std">,</span><span class="hl kwc">b</span><span class="hl std">)</span> <span class="hl kwd">paste0</span><span class="hl std">(a,b)</span>
  <span class="hl std">db_on_disc_date</span> <span class="hl kwb">&lt;-</span>
    <span class="hl kwd">file.info</span><span class="hl std">(</span>
      <span class="hl kwd">dir</span><span class="hl std">(</span>
        <span class="hl str">&quot;Z:/Gesch\u00e4ftsordnungen/database/extracts&quot;</span><span class="hl std">,</span>
        <span class="hl kwc">full.names</span> <span class="hl std">=</span> <span class="hl num">TRUE</span><span class="hl std">,</span>
        <span class="hl kwc">pattern</span>    <span class="hl std">=</span> <span class="hl str">&quot;_db_version_&quot;</span><span class="hl std">)</span>
    <span class="hl std">)</span><span class="hl opt">$</span><span class="hl std">ctime</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">max</span><span class="hl std">()</span>

  <span class="hl std">ids</span> <span class="hl kwb">&lt;-</span>
    <span class="hl std">tl_raw</span>  <span class="hl opt">%&gt;%</span>
    <span class="hl kwd">distinct</span><span class="hl std">(tl_t_id)</span> <span class="hl opt">%&gt;%</span>
    <span class="hl kwd">select</span><span class="hl std">(tl_t_id)</span> <span class="hl opt">%&gt;%</span>
    <span class="hl kwd">unlist</span><span class="hl std">()</span>

  <span class="hl std">countries</span> <span class="hl kwb">&lt;-</span>
    <span class="hl kwd">str_extract</span><span class="hl std">(ids,</span> <span class="hl str">&quot;^[A-Z]{2,10}&quot;</span><span class="hl std">)</span>

  <span class="hl std">fnames</span> <span class="hl kwb">&lt;-</span> <span class="hl std">countries</span>  <span class="hl opt">%.%</span> <span class="hl str">&quot;/&quot;</span>  <span class="hl opt">%.%</span> <span class="hl std">ids</span> <span class="hl opt">%.%</span> <span class="hl str">&quot;.htm&quot;</span>

  <span class="hl com"># make country folders</span>
  <span class="hl std">trash</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">lapply</span><span class="hl std">(</span><span class="hl kwd">unique</span><span class="hl std">(countries), dir.create,</span> <span class="hl kwc">showWarnings</span> <span class="hl std">=</span> <span class="hl num">FALSE</span><span class="hl std">)</span>

  <span class="hl com"># writing texts</span>
  <span class="hl std">needs_update</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">na_to_true</span><span class="hl std">(</span><span class="hl kwd">file.info</span><span class="hl std">(fnames)</span><span class="hl opt">$</span><span class="hl std">ctime</span> <span class="hl opt">&lt;</span> <span class="hl std">db_on_disc_date)</span>
  <span class="hl kwa">for</span><span class="hl std">( i</span> <span class="hl kwa">in</span> <span class="hl kwd">seq_along</span><span class="hl std">(ids) ) {</span>
    <span class="hl kwa">if</span> <span class="hl std">(</span> <span class="hl opt">!</span><span class="hl std">needs_update[i]  ){</span>
      <span class="hl kwa">next</span>
    <span class="hl std">}</span>
    <span class="hl std">id</span>      <span class="hl kwb">&lt;-</span> <span class="hl std">ids[i]</span>
    <span class="hl std">df</span> <span class="hl kwb">&lt;-</span>
      <span class="hl std">tl_raw</span>  <span class="hl opt">%&gt;%</span>
      <span class="hl kwd">filter</span><span class="hl std">(tl_t_id</span><span class="hl opt">==</span><span class="hl std">id)</span>  <span class="hl opt">%&gt;%</span>
      <span class="hl kwd">mutate</span><span class="hl std">(</span>
        <span class="hl kwc">tl_lnr</span><span class="hl std">=</span><span class="hl kwd">as.numeric</span><span class="hl std">(tl_lnr),</span>
        <span class="hl kwc">corpus_cat</span> <span class="hl std">=</span> <span class="hl kwd">ccode_corpus_recode</span><span class="hl std">(tl_corpus_code)</span>
      <span class="hl std">)</span> <span class="hl opt">%&gt;%</span>
      <span class="hl kwd">rename</span><span class="hl std">(</span>
        <span class="hl kwc">lnr</span><span class="hl std">=tl_lnr,</span>
        <span class="hl kwc">text</span><span class="hl std">=tl_text,</span>
        <span class="hl kwc">rel</span> <span class="hl std">= tl_relevant,</span>
        <span class="hl kwc">corpus_code</span> <span class="hl std">= tl_corpus_code,</span>
        <span class="hl kwc">memo</span> <span class="hl std">= tl_corpus_memo,</span>
        <span class="hl kwc">words_clean</span><span class="hl std">=tl_wds_clean,</span>
        <span class="hl kwc">words_raw</span><span class="hl std">=tl_wds_raw</span>
      <span class="hl std">)</span> <span class="hl opt">%&gt;%</span>
      <span class="hl kwd">select</span><span class="hl std">(lnr, rel,  text, corpus_code, corpus_cat, words_clean, words_raw)</span>  <span class="hl opt">%&gt;%</span>
      <span class="hl kwd">arrange</span><span class="hl std">(lnr)</span>


    <span class="hl std">html</span> <span class="hl kwb">&lt;-</span>
      <span class="hl str">&quot;&lt;h1&gt;&quot;</span> <span class="hl opt">%.%</span>
      <span class="hl kwd">ifelse</span><span class="hl std">(</span> <span class="hl kwd">length</span><span class="hl std">(</span><span class="hl kwd">basename</span><span class="hl std">(fnames[i</span><span class="hl opt">-</span><span class="hl num">1</span><span class="hl std">]))</span> <span class="hl opt">&gt;</span> <span class="hl num">0</span> <span class="hl opt">&amp;</span> <span class="hl kwd">identical</span><span class="hl std">(countries[i</span><span class="hl opt">-</span><span class="hl num">1</span><span class="hl std">], countries[i]),</span>
              <span class="hl str">&quot;&lt;a href='&quot;</span> <span class="hl opt">%.%</span> <span class="hl kwd">basename</span><span class="hl std">(fnames[i</span><span class="hl opt">-</span><span class="hl num">1</span><span class="hl std">])</span> <span class="hl opt">%.%</span> <span class="hl str">&quot;'&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;lt;&amp;lt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/a&gt;&quot;</span>  <span class="hl std">,</span>
              <span class="hl str">&quot;&quot;</span>
      <span class="hl std">)</span> <span class="hl opt">%.%</span>
      <span class="hl str">&quot;&quot;</span>  <span class="hl opt">%.%</span>
      <span class="hl std">id</span>  <span class="hl opt">%.%</span>
      <span class="hl kwd">ifelse</span><span class="hl std">(</span> <span class="hl kwd">length</span><span class="hl std">(</span><span class="hl kwd">basename</span><span class="hl std">(fnames[i</span><span class="hl opt">+</span><span class="hl num">1</span><span class="hl std">]))</span> <span class="hl opt">&gt;</span> <span class="hl num">0</span> <span class="hl opt">&amp;</span> <span class="hl kwd">identical</span><span class="hl std">(countries[i</span><span class="hl opt">+</span><span class="hl num">1</span><span class="hl std">], countries[i]),</span>
              <span class="hl str">&quot;&lt;a href='&quot;</span> <span class="hl opt">%.%</span> <span class="hl kwd">basename</span><span class="hl std">(fnames[i</span><span class="hl opt">+</span><span class="hl num">1</span><span class="hl std">])</span> <span class="hl opt">%.%</span> <span class="hl str">&quot;'&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/a&gt;&quot;</span>  <span class="hl std">,</span>
              <span class="hl str">&quot;&quot;</span>
      <span class="hl std">)</span> <span class="hl opt">%.%</span>
      <span class="hl str">&quot;&lt;/h1&gt;&quot;</span>

    <span class="hl kwd">htmltable</span><span class="hl std">(</span>
      <span class="hl std">df,</span>
      <span class="hl kwc">file</span> <span class="hl std">= fnames[i],</span>
      <span class="hl kwc">bgcolor</span> <span class="hl std">= ccode_color_scheme2[df</span><span class="hl opt">$</span><span class="hl std">corpus_cat],</span>
      <span class="hl kwc">html</span> <span class="hl std">= html</span>
    <span class="hl std">)</span>
  <span class="hl std">}</span>
  <span class="hl com">### &lt;&lt; producing texts # -------------------------------------------------------</span>


  <span class="hl com">### &gt;&gt; producing linkage texts # -----------------------------------------------</span>

  <span class="hl kwd">setwd</span><span class="hl std">(</span><span class="hl str">&quot;Z:/Gesch\u00e4ftsordnungen/database/outputs/linkage_and_minmaj&quot;</span><span class="hl std">)</span>

  <span class="hl com"># make country folders</span>
  <span class="hl std">trash</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">lapply</span><span class="hl std">(</span><span class="hl kwd">unique</span><span class="hl std">(countries), dir.create,</span> <span class="hl kwc">showWarnings</span> <span class="hl std">=</span> <span class="hl num">FALSE</span><span class="hl std">)</span>

  <span class="hl com"># sort tl_raw</span>
  <span class="hl std">t_raw</span> <span class="hl kwb">&lt;-</span> <span class="hl std">t_raw</span>  <span class="hl opt">%&gt;%</span> <span class="hl kwd">arrange</span><span class="hl std">(t_id)</span>

  <span class="hl com"># make combinations of ids</span>
  <span class="hl std">ids</span> <span class="hl kwb">&lt;-</span>
    <span class="hl kwd">data_frame</span><span class="hl std">(</span>
      <span class="hl kwc">id1</span> <span class="hl std">= t_raw</span><span class="hl opt">$</span><span class="hl std">t_id[</span><span class="hl num">1</span><span class="hl opt">:</span><span class="hl kwd">length</span><span class="hl std">(t_raw</span><span class="hl opt">$</span><span class="hl std">t_id)</span><span class="hl opt">-</span><span class="hl num">1</span><span class="hl std">],</span>
      <span class="hl kwc">id2</span> <span class="hl std">= t_raw</span><span class="hl opt">$</span><span class="hl std">t_id[</span><span class="hl num">2</span><span class="hl opt">:</span><span class="hl kwd">length</span><span class="hl std">(t_raw</span><span class="hl opt">$</span><span class="hl std">t_id)]</span>
    <span class="hl std">)</span>  <span class="hl opt">%&gt;%</span>
    <span class="hl kwd">filter</span><span class="hl std">(</span><span class="hl kwd">str_extract</span><span class="hl std">(.</span><span class="hl opt">$</span><span class="hl std">id1,</span><span class="hl str">&quot;^.{4}&quot;</span><span class="hl std">)</span> <span class="hl opt">==</span> <span class="hl kwd">str_extract</span><span class="hl std">(.</span><span class="hl opt">$</span><span class="hl std">id2,</span><span class="hl str">&quot;^.{4}&quot;</span><span class="hl std">))</span>  <span class="hl opt">%&gt;%</span>
    <span class="hl kwd">mutate</span><span class="hl std">(</span>
      <span class="hl kwc">fname</span> <span class="hl std">=</span> <span class="hl kwd">paste0</span><span class="hl std">(</span>
        <span class="hl kwd">str_extract</span><span class="hl std">(.</span><span class="hl opt">$</span><span class="hl std">id1,</span> <span class="hl str">&quot;^[A-Z]{2,10}&quot;</span><span class="hl std">),</span> <span class="hl str">&quot;/&quot;</span><span class="hl std">,</span>
        <span class="hl std">.</span><span class="hl opt">$</span><span class="hl std">id1,</span> <span class="hl str">&quot; vs &quot;</span><span class="hl std">, .</span><span class="hl opt">$</span><span class="hl std">id2,</span>
        <span class="hl str">&quot;.htm&quot;</span><span class="hl std">)</span>
    <span class="hl std">)</span>

  <span class="hl com"># function for links to prev or next document</span>
  <span class="hl std">ahref</span>     <span class="hl kwb">&lt;-</span>
    <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">x</span><span class="hl std">){</span>
      <span class="hl std">cntr</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">str_extract</span><span class="hl std">(</span><span class="hl kwd">basename</span><span class="hl std">(fname),</span> <span class="hl str">&quot;^[A-Z]*&quot;</span> <span class="hl std">)</span>
      <span class="hl kwa">if</span> <span class="hl std">(</span> <span class="hl kwd">length</span><span class="hl std">(x)</span><span class="hl opt">==</span><span class="hl num">0</span> <span class="hl std">)</span>     <span class="hl kwd">return</span><span class="hl std">(</span><span class="hl str">&quot;&quot;</span><span class="hl std">)</span>
      <span class="hl kwa">if</span> <span class="hl std">(</span> <span class="hl kwd">is.na</span><span class="hl std">(x) )</span>         <span class="hl kwd">return</span><span class="hl std">(</span><span class="hl str">&quot;&quot;</span><span class="hl std">)</span>
      <span class="hl kwa">if</span> <span class="hl std">(</span> <span class="hl opt">!</span><span class="hl kwd">grepl</span><span class="hl std">(cntr,</span> <span class="hl kwd">basename</span><span class="hl std">(x) ) )</span> <span class="hl kwd">return</span><span class="hl std">(</span><span class="hl str">&quot;&quot;</span><span class="hl std">)</span>
      <span class="hl kwa">if</span> <span class="hl std">( x</span> <span class="hl opt">&lt;</span> <span class="hl std">fname ){</span>
        <span class="hl kwd">return</span><span class="hl std">(</span>
          <span class="hl str">&quot;&lt;a href='&quot;</span> <span class="hl opt">%.%</span> <span class="hl kwd">basename</span><span class="hl std">(x)</span> <span class="hl opt">%.%</span> <span class="hl str">&quot;'&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;lt;&amp;lt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/a&gt;&quot;</span>
        <span class="hl std">)</span>
      <span class="hl std">}</span>
      <span class="hl kwa">if</span> <span class="hl std">( x</span> <span class="hl opt">&gt;</span> <span class="hl std">fname ){</span>
        <span class="hl kwd">return</span><span class="hl std">(</span>
          <span class="hl str">&quot;&lt;a href='&quot;</span> <span class="hl opt">%.%</span> <span class="hl kwd">basename</span><span class="hl std">(x)</span> <span class="hl opt">%.%</span> <span class="hl str">&quot;'&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/a&gt;&quot;</span>
        <span class="hl std">)</span>
      <span class="hl std">}</span>
    <span class="hl std">}</span>


  <span class="hl com"># filter by those combinations tl_t_id and write files</span>
  <span class="hl std">needs_update</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">na_to_true</span><span class="hl std">(</span><span class="hl kwd">file.info</span><span class="hl std">(ids</span><span class="hl opt">$</span><span class="hl std">fname)</span><span class="hl opt">$</span><span class="hl std">ctime</span> <span class="hl opt">&lt;</span> <span class="hl std">db_on_disc_date)</span>
  <span class="hl kwa">for</span><span class="hl std">(i</span> <span class="hl kwa">in</span> <span class="hl kwd">seq_along</span><span class="hl std">(ids</span><span class="hl opt">$</span><span class="hl std">id1) ){</span>
    <span class="hl kwa">if</span> <span class="hl std">(</span> <span class="hl opt">!</span><span class="hl std">needs_update[i] ) {</span>
      <span class="hl kwa">next</span>
    <span class="hl std">}</span>

    <span class="hl std">fname</span>      <span class="hl kwb">&lt;-</span> <span class="hl std">ids</span><span class="hl opt">$</span><span class="hl std">fname[i]</span>
    <span class="hl std">prev_fname</span> <span class="hl kwb">&lt;-</span> <span class="hl std">ids[i</span><span class="hl opt">-</span><span class="hl num">1</span><span class="hl std">, ]</span><span class="hl opt">$</span><span class="hl std">fname</span>
    <span class="hl std">next_fname</span> <span class="hl kwb">&lt;-</span> <span class="hl std">ids[i</span><span class="hl opt">+</span><span class="hl num">1</span><span class="hl std">, ]</span><span class="hl opt">$</span><span class="hl std">fname</span>
    <span class="hl std">id1</span>   <span class="hl kwb">&lt;-</span> <span class="hl std">ids</span><span class="hl opt">$</span><span class="hl std">id1[i]</span>
    <span class="hl std">id2</span>   <span class="hl kwb">&lt;-</span> <span class="hl std">ids</span><span class="hl opt">$</span><span class="hl std">id2[i]</span>

    <span class="hl com"># text output</span>
    <span class="hl std">tl1</span> <span class="hl kwb">&lt;-</span> <span class="hl std">tl_raw</span> <span class="hl opt">%&gt;%</span>
      <span class="hl kwd">filter</span><span class="hl std">( tl_t_id</span> <span class="hl opt">==</span> <span class="hl std">id1 )</span>  <span class="hl opt">%&gt;%</span>
      <span class="hl kwd">select</span><span class="hl std">(tl_id, tl_corpus_code, tl_relevant, tl_lnr, tl_text)</span>  <span class="hl opt">%&gt;%</span>
      <span class="hl kwd">rename</span><span class="hl std">(</span><span class="hl kwc">rel</span><span class="hl std">=tl_relevant,</span> <span class="hl kwc">ccode</span><span class="hl std">=tl_corpus_code,</span> <span class="hl kwc">text</span><span class="hl std">=tl_text)</span>
    <span class="hl kwd">names</span><span class="hl std">(tl1)</span> <span class="hl kwb">&lt;-</span><span class="hl kwd">paste0</span><span class="hl std">(</span><span class="hl kwd">names</span><span class="hl std">(tl1),</span> <span class="hl num">1</span><span class="hl std">)</span>

    <span class="hl std">tl2</span> <span class="hl kwb">&lt;-</span> <span class="hl std">tl_raw</span> <span class="hl opt">%&gt;%</span>
      <span class="hl kwd">filter</span><span class="hl std">( tl_t_id</span> <span class="hl opt">==</span> <span class="hl std">id2 )</span>  <span class="hl opt">%&gt;%</span>
      <span class="hl kwd">select</span><span class="hl std">(tl_id, tl_corpus_code, tl_relevant, tl_lnr, tl_text)</span>  <span class="hl opt">%&gt;%</span>
      <span class="hl kwd">rename</span><span class="hl std">(</span><span class="hl kwc">rel</span><span class="hl std">=tl_relevant,</span> <span class="hl kwc">ccode</span><span class="hl std">=tl_corpus_code,</span> <span class="hl kwc">text</span><span class="hl std">=tl_text)</span>
    <span class="hl kwd">names</span><span class="hl std">(tl2)</span> <span class="hl kwb">&lt;-</span><span class="hl kwd">paste0</span><span class="hl std">(</span><span class="hl kwd">names</span><span class="hl std">(tl2),</span> <span class="hl num">2</span><span class="hl std">)</span>

    <span class="hl std">ll</span> <span class="hl kwb">&lt;-</span> <span class="hl std">ll_raw</span>  <span class="hl opt">%&gt;%</span>
      <span class="hl kwd">filter</span><span class="hl std">( ll_t_id1</span> <span class="hl opt">==</span> <span class="hl std">id1</span> <span class="hl opt">|</span> <span class="hl std">ll_tl_id2</span> <span class="hl opt">==</span> <span class="hl std">id2 )</span> <span class="hl opt">%&gt;%</span>
      <span class="hl kwd">select</span><span class="hl std">(ll_tl_id1, ll_tl_id2, ll_tl_lnr1, ll_tl_lnr2, ll_type,</span>
             <span class="hl std">ll_sim, ll_sim_wd, ll_diff, ll_diff_wd)</span>  <span class="hl opt">%&gt;%</span>
      <span class="hl kwd">rename</span><span class="hl std">(</span>
        <span class="hl kwc">tl_id1</span>     <span class="hl std">= ll_tl_id1,</span>
        <span class="hl kwc">tl_id2</span>     <span class="hl std">= ll_tl_id2,</span>
        <span class="hl kwc">lnr1</span>       <span class="hl std">= ll_tl_lnr1,</span>
        <span class="hl kwc">lnr2</span>       <span class="hl std">= ll_tl_lnr2,</span>
        <span class="hl kwc">type</span>       <span class="hl std">= ll_type,</span>
        <span class="hl kwc">sim</span>        <span class="hl std">= ll_sim,</span>
        <span class="hl kwc">sim_words</span>  <span class="hl std">= ll_sim_wd,</span>
        <span class="hl kwc">diff</span>       <span class="hl std">= ll_diff,</span>
        <span class="hl kwc">diff_words</span> <span class="hl std">= ll_diff_wd</span>
      <span class="hl std">)</span>

    <span class="hl std">linkage</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">full_join</span><span class="hl std">( ll, tl1)</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">full_join</span><span class="hl std">(tl2)</span>
    <span class="hl std">linkage</span><span class="hl opt">$</span><span class="hl std">lnr1</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">apply</span><span class="hl std">(linkage[,</span><span class="hl kwd">c</span><span class="hl std">(</span><span class="hl str">&quot;lnr1&quot;</span><span class="hl std">,</span><span class="hl str">&quot;tl_lnr1&quot;</span><span class="hl std">)],</span> <span class="hl num">1</span><span class="hl std">, max,</span> <span class="hl kwc">na.rm</span><span class="hl std">=T,</span> <span class="hl kwc">showWarnings</span><span class="hl std">=F)</span>
    <span class="hl std">linkage</span><span class="hl opt">$</span><span class="hl std">lnr1</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">ifelse</span><span class="hl std">(</span><span class="hl kwd">is.infinite</span><span class="hl std">(linkage</span><span class="hl opt">$</span><span class="hl std">lnr1),</span> <span class="hl num">NA</span><span class="hl std">, linkage</span><span class="hl opt">$</span><span class="hl std">lnr1)</span>
    <span class="hl std">linkage</span><span class="hl opt">$</span><span class="hl std">lnr2</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">apply</span><span class="hl std">(linkage[,</span><span class="hl kwd">c</span><span class="hl std">(</span><span class="hl str">&quot;lnr2&quot;</span><span class="hl std">,</span><span class="hl str">&quot;tl_lnr2&quot;</span><span class="hl std">)],</span> <span class="hl num">1</span><span class="hl std">, max,</span> <span class="hl kwc">na.rm</span><span class="hl std">=T,</span> <span class="hl kwc">showWarnings</span><span class="hl std">=F)</span>
    <span class="hl std">linkage</span><span class="hl opt">$</span><span class="hl std">lnr2</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">ifelse</span><span class="hl std">(</span><span class="hl kwd">is.infinite</span><span class="hl std">(linkage</span><span class="hl opt">$</span><span class="hl std">lnr2),</span> <span class="hl num">NA</span><span class="hl std">, linkage</span><span class="hl opt">$</span><span class="hl std">lnr2)</span>
    <span class="hl std">linkage</span> <span class="hl kwb">&lt;-</span>
      <span class="hl std">linkage</span>  <span class="hl opt">%&gt;%</span>
      <span class="hl kwd">select</span><span class="hl std">(</span><span class="hl opt">-</span><span class="hl std">tl_lnr1,</span> <span class="hl opt">-</span><span class="hl std">tl_lnr2)</span>  <span class="hl opt">%&gt;%</span>
      <span class="hl kwd">mutate</span><span class="hl std">(</span>
        <span class="hl kwc">lnr1</span> <span class="hl std">=</span> <span class="hl kwd">ifelse</span><span class="hl std">(lnr1</span><span class="hl opt">==</span><span class="hl num">0</span><span class="hl std">,</span> <span class="hl num">NA</span><span class="hl std">, lnr1),</span>
        <span class="hl kwc">lnr2</span> <span class="hl std">=</span> <span class="hl kwd">ifelse</span><span class="hl std">(lnr2</span><span class="hl opt">==</span><span class="hl num">0</span><span class="hl std">,</span> <span class="hl num">NA</span><span class="hl std">, lnr2)</span>
      <span class="hl std">)</span>
    <span class="hl std">linkage</span> <span class="hl kwb">&lt;-</span>
      <span class="hl std">linkage</span>  <span class="hl opt">%&gt;%</span>
      <span class="hl kwd">sort_align_df</span><span class="hl std">(</span><span class="hl str">&quot;lnr1&quot;</span><span class="hl std">,</span> <span class="hl str">&quot;lnr2&quot;</span><span class="hl std">)</span>  <span class="hl opt">%&gt;%</span>
      <span class="hl kwd">select</span><span class="hl std">(lnr1, lnr2, text1, rel1, text2, rel2, type, sim, diff, sim_words, diff_words)</span>
    <span class="hl std">linkage</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as_data_frame</span><span class="hl std">(</span><span class="hl kwd">lapply</span><span class="hl std">(linkage,</span> <span class="hl kwa">function</span><span class="hl std">(</span><span class="hl kwc">x</span><span class="hl std">)</span> <span class="hl kwd">ifelse</span><span class="hl std">(</span><span class="hl kwd">is.na</span><span class="hl std">(x),</span> <span class="hl str">&quot;&quot;</span><span class="hl std">, x)) )</span>

    <span class="hl std">country</span> <span class="hl kwb">&lt;-</span>
      <span class="hl kwd">str_extract</span><span class="hl std">(tl1</span><span class="hl opt">$</span><span class="hl std">tl_id1[</span><span class="hl num">1</span><span class="hl std">],</span> <span class="hl str">&quot;^[A-Z]{3,7}&quot;</span><span class="hl std">)</span>

    <span class="hl std">versus</span> <span class="hl kwb">&lt;-</span>
      <span class="hl kwd">str_extract</span><span class="hl std">(tl1</span><span class="hl opt">$</span><span class="hl std">tl_id1[</span><span class="hl num">1</span><span class="hl std">],</span> <span class="hl str">&quot;.*\\.\\d&quot;</span><span class="hl std">)</span>  <span class="hl opt">%.%</span>
      <span class="hl str">&quot;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;  &lt;i&gt;versus&lt;/i&gt; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;</span> <span class="hl opt">%.%</span>
      <span class="hl kwd">str_extract</span><span class="hl std">(tl2</span><span class="hl opt">$</span><span class="hl std">tl_id2[</span><span class="hl num">1</span><span class="hl std">],</span> <span class="hl str">&quot;.*\\.\\d&quot;</span><span class="hl std">)</span>

    <span class="hl std">info</span>  <span class="hl kwb">&lt;-</span>
      <span class="hl str">&quot;&lt;h1&gt;&quot;</span> <span class="hl opt">%.%</span>
      <span class="hl kwd">ahref</span><span class="hl std">(prev_fname)</span> <span class="hl opt">%.%</span>
      <span class="hl std">versus</span>  <span class="hl opt">%.%</span>
      <span class="hl kwd">ahref</span><span class="hl std">(next_fname)</span>  <span class="hl opt">%.%</span>
      <span class="hl str">&quot;&lt;/h1&gt;&lt;br&gt;&quot;</span>

    <span class="hl kwd">htmltable</span><span class="hl std">(</span>
      <span class="hl kwc">file</span>    <span class="hl std">= ids</span><span class="hl opt">$</span><span class="hl std">fname[i],</span>
      <span class="hl kwc">x</span>       <span class="hl std">=</span> <span class="hl kwd">as.data.frame</span><span class="hl std">(linkage),</span>
      <span class="hl kwc">bgcolor</span> <span class="hl std">=</span> <span class="hl kwd">linkage_type_colors</span><span class="hl std">(linkage</span><span class="hl opt">$</span><span class="hl std">type),</span>
      <span class="hl kwc">html</span>    <span class="hl std">= info</span>
    <span class="hl std">)</span>
  <span class="hl std">}</span>

  <span class="hl com">### &lt;&lt; producing linkage texts # -----------------------------------------------</span>
<span class="hl std">}</span> <span class="hl com">## &lt;&lt; UPDATE_TEXTS==TRUE</span>



<span class="hl kwd">message</span><span class="hl std">(</span><span class="hl str">&quot;-- done: getting newest data from DB and updating files --&quot;</span><span class="hl std">)</span>
</pre></div>
<div class="message"><pre class="knitr r">## -- done: getting newest data from DB and updating files --
</pre></div>
</div></div>

  <p>The R session information (including the OS info, R version and all
    packages used):</p>

<div class="chunk" id="session-info"><div class="rcode"><div class="source"><pre class="knitr r">    <span class="hl kwd">sessionInfo</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## R version 3.2.1 (2015-06-18)
## Platform: x86_64-w64-mingw32/x64 (64-bit)
## Running under: Windows 8 x64 (build 9200)
## 
## locale:
## [1] LC_COLLATE=German_Germany.1252  LC_CTYPE=German_Germany.1252   
## [3] LC_MONETARY=German_Germany.1252 LC_NUMERIC=C                   
## [5] LC_TIME=German_Germany.1252    
## 
## attached base packages:
## [1] methods   stats     graphics  grDevices utils     datasets  base     
## 
## other attached packages:
##  [1] RMySQL_0.10.3     DBI_0.3.1         magrittr_1.5      foreign_0.8-65   
##  [5] stringr_1.0.0     lubridate_1.3.3   dplyr_0.4.2       plyr_1.8.3       
##  [9] idep_1.0.0.900362 knitr_1.10.5     
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_0.11.6          digest_0.6.8         assertthat_0.1       R6_2.1.0            
##  [5] formatR_1.2          evaluate_0.7         highr_0.5            stringi_0.5-5       
##  [9] lazyeval_0.1.10.9000 tools_3.2.1          parallel_3.2.1       memoise_0.2.1
</pre></div>
<div class="source"><pre class="knitr r">    <span class="hl kwd">Sys.time</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] &quot;2015-08-27 11:04:06 CEST&quot;
</pre></div>
</div></div>


</body>
</html>
