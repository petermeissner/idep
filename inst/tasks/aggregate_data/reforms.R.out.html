
<!DOCTYPE html>
<html>
<head>
<style type="text/css">
.knitr .inline {
  background-color: #f7f7f7;
  border:solid 1px #B0B0B0;
}
.error {
	font-weight: bold;
	color: #FF0000;
}
.warning {
	font-weight: bold;
}
.message {
	font-style: italic;
}
.source, .output, .warning, .error, .message {
	padding: 0 1em;
  border:solid 1px #F7F7F7;
}
.source {
  background-color: #f5f5f5;
}
.rimage .left {
  text-align: left;
}
.rimage .right {
  text-align: right;
}
.rimage .center {
  text-align: center;
}
.hl.num {
  color: #AF0F91;
}
.hl.str {
  color: #317ECC;
}
.hl.com {
  color: #AD95AF;
  font-style: italic;
}
.hl.opt {
  color: #000000;
}
.hl.std {
  color: #585858;
}
.hl.kwa {
  color: #295F94;
  font-weight: bold;
}
.hl.kwb {
  color: #B05A65;
}
.hl.kwc {
  color: #55aa55;
}
.hl.kwd {
  color: #BC5A65;
  font-weight: bold;
}
</style>
  <script src="http://yihui.name/media/js/center-images.js"></script>
  <title>A Report Generated by knitr</title>
</head>
<body>

  <p>This report is automatically generated with the R
    package <a href="http://yihui.name/knitr"><strong>knitr</strong></a>
    (version <code class="knitr inline">1.10.5</code>)
    by  pm.</p>

<div class="chunk" id="auto-report"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl com"># Script, dass die IDEP Daten aggregiert</span>
<span class="hl com"># um Minderheiten und Mehrheiten freundliche Reformen damit analysieren zu k?nnen</span>



<span class="hl com">#### preparations ==============================================================</span>

<span class="hl kwd">library</span><span class="hl std">(idep)</span>
<span class="hl kwd">library</span><span class="hl std">(stringr)</span>
<span class="hl kwd">library</span><span class="hl std">(dplyr)</span>
<span class="hl kwd">library</span><span class="hl std">(magrittr)</span>
<span class="hl kwd">library</span><span class="hl std">(foreign)</span>
<span class="hl kwd">library</span><span class="hl std">(reshape2)</span>

<span class="hl std">data_path</span>  <span class="hl kwb">&lt;-</span> <span class="hl str">&quot;z:/gesch\u00e4ftsordnungen/database/extracts/&quot;</span>
<span class="hl kwd">setwd</span><span class="hl std">(data_path)</span>


<span class="hl com"># version check </span>
<span class="hl std">db_on_disk_version</span> <span class="hl kwb">&lt;-</span>
  <span class="hl kwd">str_extract</span><span class="hl std">(</span><span class="hl kwd">list.files</span><span class="hl std">(),</span> <span class="hl str">&quot;\\d+\\.\\d+&quot;</span><span class="hl std">)</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">as.numeric</span><span class="hl std">()</span>  <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">max</span><span class="hl std">(</span><span class="hl kwc">na.rm</span><span class="hl std">=T)</span>
<span class="hl std">db_on_disk_version</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] 1.27
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com">#### loading data ==============================================================</span>

<span class="hl com"># pick newest view file and load it</span>
<span class="hl std">fname</span> <span class="hl kwb">&lt;-</span>
  <span class="hl std">data_path</span>  <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">list.files</span><span class="hl std">(</span><span class="hl kwc">pattern</span><span class="hl std">=</span><span class="hl str">&quot;view_linelinkage_db_version_.*Rdata&quot;</span><span class="hl std">)</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">tail</span><span class="hl std">(</span><span class="hl num">1</span><span class="hl std">)</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">paste0</span><span class="hl std">(data_path,.)</span>

<span class="hl kwd">load</span><span class="hl std">(fname)</span>
<span class="hl std">view</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as_data_frame</span><span class="hl std">(linelinkage)</span>
<span class="hl kwd">rm</span><span class="hl std">(linelinkage)</span>

<span class="hl kwd">Encoding</span><span class="hl std">(view</span><span class="hl opt">$</span><span class="hl std">tl_text1)</span> <span class="hl kwb">&lt;-</span> <span class="hl str">&quot;UTF-8&quot;</span>
<span class="hl kwd">Encoding</span><span class="hl std">(view</span><span class="hl opt">$</span><span class="hl std">tl_text2)</span> <span class="hl kwb">&lt;-</span> <span class="hl str">&quot;UTF-8&quot;</span>


<span class="hl com"># pick newest texts file and load it</span>
<span class="hl std">fname</span> <span class="hl kwb">&lt;-</span>
  <span class="hl std">data_path</span>  <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">list.files</span><span class="hl std">(</span><span class="hl kwc">pattern</span><span class="hl std">=</span><span class="hl str">&quot;raw_texts_db_version_.*.Rdata&quot;</span><span class="hl std">)</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">tail</span><span class="hl std">(</span><span class="hl num">1</span><span class="hl std">)</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">paste0</span><span class="hl std">(data_path,.)</span>

<span class="hl kwd">load</span><span class="hl std">(fname)</span>
<span class="hl std">texts</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as_data_frame</span><span class="hl std">(dbdat)</span>
<span class="hl kwd">rm</span><span class="hl std">(dbdat)</span>


<span class="hl com"># pick newest linelinkage file and load it</span>
<span class="hl std">fname</span> <span class="hl kwb">&lt;-</span>
  <span class="hl std">data_path</span>  <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">list.files</span><span class="hl std">(</span><span class="hl kwc">pattern</span><span class="hl std">=</span><span class="hl str">&quot;raw_linelinkage_db_version_.*.Rdata&quot;</span><span class="hl std">)</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">tail</span><span class="hl std">(</span><span class="hl num">1</span><span class="hl std">)</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">paste0</span><span class="hl std">(data_path,.)</span>

<span class="hl kwd">load</span><span class="hl std">(fname)</span>
<span class="hl std">linkage</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as_data_frame</span><span class="hl std">(linelinkage)</span>
<span class="hl kwd">rm</span><span class="hl std">(linelinkage)</span>


<span class="hl com"># pick newest textline file and load it</span>
<span class="hl std">fname</span> <span class="hl kwb">&lt;-</span>
  <span class="hl std">data_path</span>  <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">list.files</span><span class="hl std">(</span><span class="hl kwc">pattern</span><span class="hl std">=</span><span class="hl str">&quot;raw_textlines_db_version_.*.Rdata&quot;</span><span class="hl std">)</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">tail</span><span class="hl std">(</span><span class="hl num">1</span><span class="hl std">)</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">paste0</span><span class="hl std">(data_path,.)</span>

<span class="hl kwd">load</span><span class="hl std">(fname)</span>
<span class="hl std">lines</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as_data_frame</span><span class="hl std">(dbdat)</span>
<span class="hl kwd">rm</span><span class="hl std">(dbdat)</span>
<span class="hl std">lines</span>  <span class="hl kwb">&lt;-</span>
  <span class="hl std">lines</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">rename</span><span class="hl std">(</span><span class="hl kwc">t_id</span> <span class="hl std">= tl_t_id)</span>
<span class="hl kwd">Encoding</span><span class="hl std">(lines</span><span class="hl opt">$</span><span class="hl std">tl_text)</span> <span class="hl kwb">&lt;-</span> <span class="hl str">&quot;UTF-8&quot;</span>

<span class="hl com"># echo db version in use</span>
<span class="hl kwd">message</span><span class="hl std">(</span><span class="hl kwd">str_extract</span><span class="hl std">(fname,</span> <span class="hl str">&quot;db_version_\\d*\\.\\d*&quot;</span><span class="hl std">))</span>
</pre></div>
<div class="message"><pre class="knitr r">## db_version_1.27
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com"># remove stuff</span>
<span class="hl kwd">rm</span><span class="hl std">(data_path)</span>
<span class="hl kwd">rm</span><span class="hl std">(fname)</span>





<span class="hl com">#### aggregation of data =======================================================</span>

<span class="hl std">reforms</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as_data_frame</span><span class="hl std">(texts)</span>


<span class="hl std">firstids</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">character</span><span class="hl std">()</span>
<span class="hl kwa">for</span><span class="hl std">( i</span> <span class="hl kwa">in</span> <span class="hl kwd">unique</span><span class="hl std">(reforms</span><span class="hl opt">$</span><span class="hl std">t_country) ) {</span>
  <span class="hl std">firstids</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">c</span><span class="hl std">(firstids,</span> <span class="hl kwd">min</span><span class="hl std">(reforms</span><span class="hl opt">$</span><span class="hl std">t_id[reforms</span><span class="hl opt">$</span><span class="hl std">t_country</span><span class="hl opt">==</span><span class="hl std">i]))</span>
<span class="hl std">}</span>


<span class="hl com">## adding length variables</span>
<span class="hl std">lines</span> <span class="hl kwb">&lt;-</span>  <span class="hl kwd">group_by</span><span class="hl std">(lines, t_id )</span>

<span class="hl std">tmp</span> <span class="hl kwb">&lt;-</span>
  <span class="hl std">lines</span> <span class="hl opt">%&gt;%</span> <span class="hl kwd">summarize</span><span class="hl std">(</span>
              <span class="hl kwc">lns_all</span>     <span class="hl std">=</span> <span class="hl kwd">n</span><span class="hl std">() ,</span>
              <span class="hl kwc">wds_raw_all</span>   <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(tl_wds_raw),</span>
              <span class="hl kwc">wds_clean_all</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(tl_wds_clean)</span>
            <span class="hl std">)</span>
<span class="hl std">reforms</span> <span class="hl kwb">&lt;-</span>
  <span class="hl kwd">left_join</span><span class="hl std">(reforms, tmp)</span>
</pre></div>
<div class="message"><pre class="knitr r">## Joining by: &quot;t_id&quot;
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl std">tmp</span> <span class="hl kwb">&lt;-</span>
  <span class="hl std">lines</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">filter</span><span class="hl std">( tl_relevant</span><span class="hl opt">==</span><span class="hl num">1</span> <span class="hl std">)</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">summarize</span><span class="hl std">(</span>
    <span class="hl kwc">lns_rel</span>     <span class="hl std">=</span> <span class="hl kwd">n</span><span class="hl std">() ,</span>
    <span class="hl kwc">wds_raw_rel</span>   <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(tl_wds_raw),</span>
    <span class="hl kwc">wds_clean_rel</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(tl_wds_clean)</span>
  <span class="hl std">)</span>
<span class="hl std">reforms</span> <span class="hl kwb">&lt;-</span>
  <span class="hl kwd">left_join</span><span class="hl std">(reforms, tmp)</span>
</pre></div>
<div class="message"><pre class="knitr r">## Joining by: &quot;t_id&quot;
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com">## adding difference variables</span>
<span class="hl std">linkage1</span> <span class="hl kwb">&lt;-</span>  <span class="hl kwd">group_by</span><span class="hl std">(linkage, ll_t_id1)</span>
<span class="hl std">linkage2</span> <span class="hl kwb">&lt;-</span>  <span class="hl kwd">group_by</span><span class="hl std">(linkage, ll_t_id2)</span>



<span class="hl com"># ... change  </span>
  <span class="hl std">tmp</span> <span class="hl kwb">&lt;-</span>
    <span class="hl std">linkage2</span>  <span class="hl opt">%&gt;%</span>
    <span class="hl kwd">filter</span><span class="hl std">(ll_type</span><span class="hl opt">==</span><span class="hl str">&quot;change&quot;</span><span class="hl std">)</span> <span class="hl opt">%&gt;%</span>
    <span class="hl kwd">summarize</span><span class="hl std">(</span>
      <span class="hl kwc">lns_mdf</span>      <span class="hl std">=</span> <span class="hl kwd">n</span><span class="hl std">(),</span>
      <span class="hl kwc">wds_mdf</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(ll_diff_wd),</span>
      <span class="hl kwc">pro_maj_mdf</span>  <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(ll_minmaj_code</span><span class="hl opt">==</span><span class="hl num">1</span><span class="hl std">),</span>
      <span class="hl kwc">pro_min_mdf</span>  <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(ll_minmaj_code</span><span class="hl opt">==</span><span class="hl num">2</span><span class="hl std">),</span>
      <span class="hl kwc">pro_non_mdf</span>  <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(ll_minmaj_code</span><span class="hl opt">==</span><span class="hl num">0</span><span class="hl std">),</span>
      <span class="hl kwc">wds_pro_maj_mdf</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">((ll_minmaj_code</span><span class="hl opt">==</span><span class="hl num">1</span><span class="hl std">)</span><span class="hl opt">*</span><span class="hl std">ll_diff_wd),</span>
      <span class="hl kwc">wds_pro_min_mdf</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">((ll_minmaj_code</span><span class="hl opt">==</span><span class="hl num">2</span><span class="hl std">)</span><span class="hl opt">*</span><span class="hl std">ll_diff_wd),</span>
      <span class="hl kwc">wds_pro_non_mdf</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">((ll_minmaj_code</span><span class="hl opt">==</span><span class="hl num">0</span><span class="hl std">)</span><span class="hl opt">*</span><span class="hl std">ll_diff_wd)</span>
    <span class="hl std">)</span>  <span class="hl opt">%&gt;%</span>
    <span class="hl kwd">rename</span><span class="hl std">(</span><span class="hl kwc">t_id</span> <span class="hl std">= ll_t_id2)</span> <span class="hl opt">%&gt;%</span>
    <span class="hl kwd">left_join</span><span class="hl std">(reforms[,</span><span class="hl str">&quot;t_id&quot;</span><span class="hl std">], .)</span>
</pre></div>
<div class="message"><pre class="knitr r">## Joining by: &quot;t_id&quot;
</pre></div>
<div class="source"><pre class="knitr r">  <span class="hl std">tmp[</span><span class="hl kwd">is.na</span><span class="hl std">(tmp)]</span> <span class="hl kwb">&lt;-</span> <span class="hl num">0</span>

  <span class="hl std">reforms</span> <span class="hl kwb">&lt;-</span>
    <span class="hl kwd">left_join</span><span class="hl std">(reforms, tmp)</span>
</pre></div>
<div class="message"><pre class="knitr r">## Joining by: &quot;t_id&quot;
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com">#   # check : change_summing_up</span>
<span class="hl com">#     sum_of_its_parts &lt;- tmp$wds_pro_maj_chg + tmp$wds_pro_min_chg + tmp$wds_pro_non_chg != tmp$wds_diff_chg</span>
<span class="hl com">#     iffer &lt;- na_to_false( sum_of_its_parts )</span>
<span class="hl com">#     tmp[iffer,]  %&gt;% select(-(pro_maj_chg:pro_non_chg)) # -&gt; should be empty</span>
<span class="hl com">#     tmp[is.na(sum_of_its_parts), ] # -&gt; should be only SWI</span>


<span class="hl com"># ... insertion</span>
  <span class="hl std">tmp</span> <span class="hl kwb">&lt;-</span>
    <span class="hl std">linkage2</span>  <span class="hl opt">%&gt;%</span>
    <span class="hl kwd">filter</span><span class="hl std">(ll_type</span><span class="hl opt">==</span><span class="hl str">&quot;insertion&quot;</span><span class="hl std">)</span> <span class="hl opt">%&gt;%</span>
    <span class="hl kwd">summarize</span><span class="hl std">(</span>
      <span class="hl kwc">wds_ins</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(ll_diff_wd),</span>
      <span class="hl kwc">lns_ins</span> <span class="hl std">=</span> <span class="hl kwd">n</span><span class="hl std">(),</span>
      <span class="hl kwc">pro_maj_ins</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(ll_minmaj_code</span><span class="hl opt">==</span><span class="hl num">1</span><span class="hl std">),</span>
      <span class="hl kwc">pro_min_ins</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(ll_minmaj_code</span><span class="hl opt">==</span><span class="hl num">2</span><span class="hl std">),</span>
      <span class="hl kwc">pro_non_ins</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(ll_minmaj_code</span><span class="hl opt">==</span><span class="hl num">0</span><span class="hl std">),</span>
      <span class="hl kwc">wds_pro_maj_ins</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">((ll_minmaj_code</span><span class="hl opt">==</span><span class="hl num">1</span><span class="hl std">)</span><span class="hl opt">*</span><span class="hl std">ll_diff_wd),</span>
      <span class="hl kwc">wds_pro_min_ins</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">((ll_minmaj_code</span><span class="hl opt">==</span><span class="hl num">2</span><span class="hl std">)</span><span class="hl opt">*</span><span class="hl std">ll_diff_wd),</span>
      <span class="hl kwc">wds_pro_non_ins</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">((ll_minmaj_code</span><span class="hl opt">==</span><span class="hl num">0</span><span class="hl std">)</span><span class="hl opt">*</span><span class="hl std">ll_diff_wd)</span>
    <span class="hl std">)</span>  <span class="hl opt">%&gt;%</span>
    <span class="hl kwd">rename</span><span class="hl std">(</span><span class="hl kwc">t_id</span> <span class="hl std">= ll_t_id2)</span> <span class="hl opt">%&gt;%</span>
    <span class="hl kwd">left_join</span><span class="hl std">(reforms[,</span><span class="hl str">&quot;t_id&quot;</span><span class="hl std">], .)</span>
</pre></div>
<div class="message"><pre class="knitr r">## Joining by: &quot;t_id&quot;
</pre></div>
<div class="source"><pre class="knitr r">  <span class="hl std">tmp[</span><span class="hl kwd">is.na</span><span class="hl std">(tmp)]</span> <span class="hl kwb">&lt;-</span> <span class="hl num">0</span>

  <span class="hl std">reforms</span> <span class="hl kwb">&lt;-</span>
    <span class="hl kwd">left_join</span><span class="hl std">(reforms, tmp)</span>
</pre></div>
<div class="message"><pre class="knitr r">## Joining by: &quot;t_id&quot;
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com">#    # check : insertion_summing_up</span>
<span class="hl com"># sum_of_its_parts &lt;-tmp$wds_pro_maj_ins + tmp$wds_pro_min_ins + tmp$wds_pro_non_ins != tmp$wds_diff_ins</span>
<span class="hl com"># iffer &lt;- na_to_false( sum_of_its_parts )</span>
<span class="hl com"># tmp[iffer,]  %&gt;% select(-(pro_maj_ins:pro_non_ins))</span>
<span class="hl com"># tmp[is.na(sum_of_its_parts), ]  %&gt;% extract(&quot;t_id&quot;)  %&gt;% as.data.frame()</span>


<span class="hl com"># ... deletion</span>
<span class="hl std">tmp</span> <span class="hl kwb">&lt;-</span>
  <span class="hl std">linkage1</span>  <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">filter</span><span class="hl std">(ll_type</span><span class="hl opt">==</span><span class="hl str">&quot;deletion&quot;</span><span class="hl std">)</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">summarize</span><span class="hl std">(</span>
    <span class="hl kwc">wds_del</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(ll_diff_wd),</span>
    <span class="hl kwc">lns_del</span> <span class="hl std">=</span> <span class="hl kwd">n</span><span class="hl std">(),</span>
    <span class="hl kwc">pro_maj_del</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(ll_minmaj_code</span><span class="hl opt">==</span><span class="hl num">1</span><span class="hl std">),</span>
    <span class="hl kwc">pro_min_del</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(ll_minmaj_code</span><span class="hl opt">==</span><span class="hl num">2</span><span class="hl std">),</span>
    <span class="hl kwc">pro_non_del</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">(ll_minmaj_code</span><span class="hl opt">==</span><span class="hl num">0</span><span class="hl std">),</span>
    <span class="hl kwc">wds_pro_maj_del</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">((ll_minmaj_code</span><span class="hl opt">==</span><span class="hl num">1</span><span class="hl std">)</span><span class="hl opt">*</span><span class="hl std">ll_diff_wd),</span>
    <span class="hl kwc">wds_pro_min_del</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">((ll_minmaj_code</span><span class="hl opt">==</span><span class="hl num">2</span><span class="hl std">)</span><span class="hl opt">*</span><span class="hl std">ll_diff_wd),</span>
    <span class="hl kwc">wds_pro_non_del</span> <span class="hl std">=</span> <span class="hl kwd">sum</span><span class="hl std">((ll_minmaj_code</span><span class="hl opt">==</span><span class="hl num">0</span><span class="hl std">)</span><span class="hl opt">*</span><span class="hl std">ll_diff_wd)</span>
  <span class="hl std">)</span>  <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">rename</span><span class="hl std">(</span><span class="hl kwc">t_id</span> <span class="hl std">= ll_t_id1)</span> <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">left_join</span><span class="hl std">(reforms[,</span><span class="hl str">&quot;t_id&quot;</span><span class="hl std">], .)</span>
</pre></div>
<div class="message"><pre class="knitr r">## Joining by: &quot;t_id&quot;
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl std">tmp[</span><span class="hl kwd">is.na</span><span class="hl std">(tmp)]</span> <span class="hl kwb">&lt;-</span> <span class="hl num">0</span>

<span class="hl std">reforms</span> <span class="hl kwb">&lt;-</span>
  <span class="hl kwd">left_join</span><span class="hl std">(reforms, tmp)</span>
</pre></div>
<div class="message"><pre class="knitr r">## Joining by: &quot;t_id&quot;
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com">#    # check : deletion_summing_up</span>
<span class="hl com"># sum_of_its_parts &lt;-tmp$wds_pro_maj_del + tmp$wds_pro_min_del + tmp$wds_pro_non_del != tmp$wds_diff_del</span>
<span class="hl com"># iffer &lt;- na_to_false( sum_of_its_parts )</span>
<span class="hl com"># tmp[iffer,]  %&gt;% select(-(pro_maj_del:pro_non_del))</span>
<span class="hl com"># tmp[is.na(sum_of_its_parts), ]  %&gt;% extract(&quot;t_id&quot;)  %&gt;% as.data.frame()</span>


<span class="hl com"># # check : no change hgas no pro-min-maj coding </span>
<span class="hl com"># # ... no-change ... only for checking, does not make sense</span>
<span class="hl com"># tmp &lt;- </span>
<span class="hl com">#   linkage2  %&gt;% </span>
<span class="hl com">#   filter(ll_type==&quot;no-change&quot;) %&gt;% </span>
<span class="hl com">#   summarize(</span>
<span class="hl com">#     wds_diff_non = sum(ll_diff_wd),</span>
<span class="hl com">#     diff_non = mean(ll_diff),</span>
<span class="hl com">#     pro_maj_non = sum(ll_minmaj_code==1),</span>
<span class="hl com">#     pro_min_non = sum(ll_minmaj_code==2),</span>
<span class="hl com">#     pro_non_non = sum(ll_minmaj_code==0),</span>
<span class="hl com">#     wds_pro_maj_non = sum((ll_minmaj_code==1)*ll_diff_wd),</span>
<span class="hl com">#     wds_pro_min_non = sum((ll_minmaj_code==2)*ll_diff_wd),</span>
<span class="hl com">#     wds_pro_non_nopn = sum((ll_minmaj_code==0)*ll_diff_wd)</span>
<span class="hl com">#   )  %&gt;% </span>
<span class="hl com">#   rename(t_id = ll_t_id2)</span>

<span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">pro_maj</span>     <span class="hl kwb">&lt;-</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">pro_maj_mdf</span> <span class="hl opt">+</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">pro_maj_ins</span> <span class="hl opt">+</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">pro_maj_del</span>
<span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">pro_min</span>     <span class="hl kwb">&lt;-</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">pro_min_mdf</span> <span class="hl opt">+</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">pro_min_ins</span> <span class="hl opt">+</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">pro_min_del</span>
<span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">pro_non</span>     <span class="hl kwb">&lt;-</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">pro_non_mdf</span> <span class="hl opt">+</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">pro_non_ins</span> <span class="hl opt">+</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">pro_non_del</span>

<span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">wds_pro_maj</span> <span class="hl kwb">&lt;-</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">wds_pro_maj_mdf</span> <span class="hl opt">+</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">wds_pro_maj_ins</span> <span class="hl opt">+</span><span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">wds_pro_maj_del</span>
<span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">wds_pro_min</span> <span class="hl kwb">&lt;-</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">wds_pro_min_mdf</span> <span class="hl opt">+</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">wds_pro_min_ins</span> <span class="hl opt">+</span><span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">wds_pro_min_del</span>
<span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">wds_pro_non</span> <span class="hl kwb">&lt;-</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">wds_pro_non_mdf</span> <span class="hl opt">+</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">wds_pro_non_ins</span> <span class="hl opt">+</span><span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">wds_pro_non_del</span>

<span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">lns_chg</span> <span class="hl kwb">&lt;-</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">lns_mdf</span> <span class="hl opt">+</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">lns_ins</span> <span class="hl opt">+</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">lns_del</span>
<span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">wds_chg</span> <span class="hl kwb">&lt;-</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">wds_mdf</span> <span class="hl opt">+</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">wds_ins</span> <span class="hl opt">+</span> <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">wds_del</span>



<span class="hl com">#### setting NA ================================================================</span>
<span class="hl com"># names(reforms)</span>

<span class="hl std">reforms[</span>
  <span class="hl std">reforms</span><span class="hl opt">$</span><span class="hl std">t_id</span> <span class="hl opt">%in%</span> <span class="hl std">firstids,</span>
  <span class="hl kwd">which</span><span class="hl std">(</span><span class="hl kwd">colnames</span><span class="hl std">(reforms)</span><span class="hl opt">==</span><span class="hl str">&quot;lns_mdf&quot;</span><span class="hl std">)</span><span class="hl opt">:</span>
    <span class="hl kwd">which</span><span class="hl std">(</span><span class="hl kwd">colnames</span><span class="hl std">(reforms)</span><span class="hl opt">==</span><span class="hl str">&quot;wds_pro_non&quot;</span><span class="hl std">)</span>
  <span class="hl std">]</span> <span class="hl kwb">&lt;-</span> <span class="hl num">NA</span>

<span class="hl std">reforms[</span>
  <span class="hl kwd">grep</span><span class="hl std">(</span><span class="hl str">&quot;^SWI&quot;</span><span class="hl std">, reforms</span><span class="hl opt">$</span><span class="hl std">t_id),</span>
  <span class="hl kwd">grep</span><span class="hl std">(</span><span class="hl str">&quot;pro_&quot;</span><span class="hl std">,</span> <span class="hl kwd">colnames</span><span class="hl std">(reforms))</span>
  <span class="hl std">]</span> <span class="hl kwb">&lt;-</span> <span class="hl num">NA</span>



<span class="hl com">#### corpus codes ==============================================================</span>

<span class="hl com"># lines </span>
<span class="hl std">lines_agg</span> <span class="hl kwb">&lt;-</span>
  <span class="hl kwd">group_by</span><span class="hl std">(lines, t_id, tl_corpus_code )</span>

<span class="hl std">tmp</span> <span class="hl kwb">&lt;-</span>
  <span class="hl kwd">aggregate</span><span class="hl std">(</span>
    <span class="hl std">lines_agg</span><span class="hl opt">$</span><span class="hl std">tl_wds_clean,</span>
    <span class="hl kwc">by</span>  <span class="hl std">=</span> <span class="hl kwd">list</span><span class="hl std">(lines_agg</span><span class="hl opt">$</span><span class="hl std">t_id, lines_agg</span><span class="hl opt">$</span><span class="hl std">tl_corpus_code),</span>
    <span class="hl kwc">FUN</span> <span class="hl std">= length</span>
  <span class="hl std">)</span>
<span class="hl kwd">names</span><span class="hl std">(tmp)</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl str">&quot;t_id&quot;</span><span class="hl std">,</span><span class="hl str">&quot;corpus&quot;</span><span class="hl std">,</span><span class="hl str">&quot;lns_corp&quot;</span><span class="hl std">)</span>
<span class="hl std">tmp</span> <span class="hl kwb">&lt;-</span>
  <span class="hl kwd">reshape</span><span class="hl std">(tmp,</span>  <span class="hl kwc">idvar</span><span class="hl std">=</span><span class="hl str">&quot;t_id&quot;</span><span class="hl std">,</span> <span class="hl kwc">timevar</span><span class="hl std">=</span><span class="hl str">&quot;corpus&quot;</span><span class="hl std">,</span> <span class="hl kwc">direction</span><span class="hl std">=</span><span class="hl str">&quot;wide&quot;</span><span class="hl std">,</span> <span class="hl kwc">sep</span><span class="hl std">=</span><span class="hl str">&quot;_&quot;</span><span class="hl std">)</span>  <span class="hl opt">%&gt;%</span>
  <span class="hl kwd">as_data_frame</span><span class="hl std">()</span>
<span class="hl std">tmp</span> <span class="hl kwb">&lt;-</span>
  <span class="hl kwd">left_join</span><span class="hl std">(reforms[,</span> <span class="hl str">&quot;t_id&quot;</span><span class="hl std">], tmp)</span>
</pre></div>
<div class="message"><pre class="knitr r">## Joining by: &quot;t_id&quot;
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl std">tmp[</span><span class="hl kwd">is.na</span><span class="hl std">(tmp)]</span> <span class="hl kwb">&lt;-</span> <span class="hl num">0</span>

<span class="hl std">reforms</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">left_join</span><span class="hl std">(reforms, tmp)</span>
</pre></div>
<div class="message"><pre class="knitr r">## Joining by: &quot;t_id&quot;
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com"># words </span>
<span class="hl std">tmp</span> <span class="hl kwb">&lt;-</span>
  <span class="hl kwd">aggregate</span><span class="hl std">(</span>
    <span class="hl std">lines_agg</span><span class="hl opt">$</span><span class="hl std">tl_wds_clean,</span>
    <span class="hl kwc">by</span>  <span class="hl std">=</span> <span class="hl kwd">list</span><span class="hl std">(lines_agg</span><span class="hl opt">$</span><span class="hl std">t_id, lines_agg</span><span class="hl opt">$</span><span class="hl std">tl_corpus_code),</span>
    <span class="hl kwc">FUN</span> <span class="hl std">= sum,</span>
    <span class="hl kwc">na.rm</span> <span class="hl std">=</span> <span class="hl num">TRUE</span>
  <span class="hl std">)</span>
<span class="hl kwd">names</span><span class="hl std">(tmp)</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl str">&quot;t_id&quot;</span><span class="hl std">,</span><span class="hl str">&quot;corpus&quot;</span><span class="hl std">,</span><span class="hl str">&quot;wds_corp&quot;</span><span class="hl std">)</span>
<span class="hl std">tmp</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">reshape</span><span class="hl std">(tmp,</span>  <span class="hl kwc">idvar</span><span class="hl std">=</span><span class="hl str">&quot;t_id&quot;</span><span class="hl std">,</span> <span class="hl kwc">timevar</span><span class="hl std">=</span><span class="hl str">&quot;corpus&quot;</span><span class="hl std">,</span> <span class="hl kwc">direction</span><span class="hl std">=</span><span class="hl str">&quot;wide&quot;</span><span class="hl std">,</span> <span class="hl kwc">sep</span><span class="hl std">=</span><span class="hl str">&quot;_&quot;</span><span class="hl std">)</span>
<span class="hl std">tmp[</span><span class="hl kwd">is.na</span><span class="hl std">(tmp)]</span> <span class="hl kwb">&lt;-</span> <span class="hl num">0</span>

<span class="hl std">reforms</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">left_join</span><span class="hl std">(reforms, tmp)</span>
</pre></div>
<div class="message"><pre class="knitr r">## Joining by: &quot;t_id&quot;
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com"># lines for code_scheme</span>
<span class="hl std">tmp</span> <span class="hl kwb">&lt;-</span>
  <span class="hl kwd">aggregate</span><span class="hl std">(</span>
    <span class="hl std">lines_agg</span><span class="hl opt">$</span><span class="hl std">tl_wds_clean,</span>
    <span class="hl kwc">by</span>   <span class="hl std">=</span> <span class="hl kwd">list</span><span class="hl std">(lines_agg</span><span class="hl opt">$</span><span class="hl std">t_id,</span> <span class="hl kwd">ccode_corpus_recode</span><span class="hl std">(lines_agg</span><span class="hl opt">$</span><span class="hl std">tl_corpus_code)),</span>
    <span class="hl kwc">FUN</span>  <span class="hl std">= length</span>
  <span class="hl std">)</span>
<span class="hl kwd">names</span><span class="hl std">(tmp)</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl str">&quot;t_id&quot;</span><span class="hl std">,</span><span class="hl str">&quot;corp_agg&quot;</span><span class="hl std">,</span><span class="hl str">&quot;lns_corp_agg&quot;</span><span class="hl std">)</span>
<span class="hl std">tmp</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">reshape</span><span class="hl std">(tmp,</span>  <span class="hl kwc">idvar</span><span class="hl std">=</span><span class="hl str">&quot;t_id&quot;</span><span class="hl std">,</span> <span class="hl kwc">timevar</span><span class="hl std">=</span><span class="hl str">&quot;corp_agg&quot;</span><span class="hl std">,</span> <span class="hl kwc">direction</span><span class="hl std">=</span><span class="hl str">&quot;wide&quot;</span><span class="hl std">,</span> <span class="hl kwc">sep</span><span class="hl std">=</span><span class="hl str">&quot;_&quot;</span><span class="hl std">)</span>
<span class="hl std">tmp[</span><span class="hl kwd">is.na</span><span class="hl std">(tmp)]</span> <span class="hl kwb">&lt;-</span> <span class="hl num">0</span>

<span class="hl std">reforms</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">left_join</span><span class="hl std">(reforms, tmp)</span>
</pre></div>
<div class="message"><pre class="knitr r">## Joining by: &quot;t_id&quot;
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com"># wds for code_scheme</span>
<span class="hl std">tmp</span> <span class="hl kwb">&lt;-</span>
  <span class="hl kwd">aggregate</span><span class="hl std">(</span>
    <span class="hl std">lines_agg</span><span class="hl opt">$</span><span class="hl std">tl_wds_clean,</span>
    <span class="hl kwc">by</span>    <span class="hl std">=</span> <span class="hl kwd">list</span><span class="hl std">(lines_agg</span><span class="hl opt">$</span><span class="hl std">t_id,</span> <span class="hl kwd">ccode_corpus_recode</span><span class="hl std">(lines_agg</span><span class="hl opt">$</span><span class="hl std">tl_corpus_code)),</span>
    <span class="hl kwc">FUN</span>   <span class="hl std">= sum,</span>
    <span class="hl kwc">na.rm</span> <span class="hl std">=</span> <span class="hl num">TRUE</span>
  <span class="hl std">)</span>
<span class="hl kwd">names</span><span class="hl std">(tmp)</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl str">&quot;t_id&quot;</span><span class="hl std">,</span><span class="hl str">&quot;corp_agg&quot;</span><span class="hl std">,</span><span class="hl str">&quot;wds_corp_agg&quot;</span><span class="hl std">)</span>
<span class="hl std">tmp</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">reshape</span><span class="hl std">(tmp,</span>  <span class="hl kwc">idvar</span><span class="hl std">=</span><span class="hl str">&quot;t_id&quot;</span><span class="hl std">,</span> <span class="hl kwc">timevar</span><span class="hl std">=</span><span class="hl str">&quot;corp_agg&quot;</span><span class="hl std">,</span> <span class="hl kwc">direction</span><span class="hl std">=</span><span class="hl str">&quot;wide&quot;</span><span class="hl std">,</span> <span class="hl kwc">sep</span><span class="hl std">=</span><span class="hl str">&quot;_&quot;</span><span class="hl std">)</span>
<span class="hl std">tmp[</span><span class="hl kwd">is.na</span><span class="hl std">(tmp)]</span> <span class="hl kwb">&lt;-</span> <span class="hl num">0</span>

<span class="hl std">reforms</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">left_join</span><span class="hl std">(reforms, tmp)</span>
</pre></div>
<div class="message"><pre class="knitr r">## Joining by: &quot;t_id&quot;
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com">#### saving ====================================================================</span>

<span class="hl com"># save overview HTML</span>
<span class="hl kwd">setwd</span><span class="hl std">(</span><span class="hl str">&quot;Z:/Gesch\u00e4ftsordnungen/database/outputs&quot;</span><span class="hl std">)</span>
<span class="hl kwd">htmltable</span><span class="hl std">(reforms,</span> <span class="hl kwc">file</span><span class="hl std">=</span><span class="hl kwd">paste0</span><span class="hl std">(</span><span class="hl str">&quot;reforms.htm&quot;</span><span class="hl std">))</span>
</pre></div>
<div class="message"><pre class="knitr r">## Writing output to file: reforms.htm
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl com"># save reforms dataset</span>
<span class="hl kwd">setwd</span><span class="hl std">(</span><span class="hl str">&quot;Z:/Gesch\u00e4ftsordnungen/database/aggregats&quot;</span><span class="hl std">)</span>
<span class="hl kwd">save</span><span class="hl std">(reforms,</span> <span class="hl kwc">file</span><span class="hl std">=</span><span class="hl str">&quot;reforms.Rdata&quot;</span><span class="hl std">)</span>
<span class="hl kwd">write.dta</span><span class="hl std">(reforms,</span> <span class="hl kwc">file</span><span class="hl std">=</span><span class="hl str">&quot;reforms.dta&quot;</span><span class="hl std">)</span>
</pre></div>
</div></div>

  <p>The R session information (including the OS info, R version and all
    packages used):</p>

<div class="chunk" id="session-info"><div class="rcode"><div class="source"><pre class="knitr r">    <span class="hl kwd">sessionInfo</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## R version 3.2.1 (2015-06-18)
## Platform: x86_64-w64-mingw32/x64 (64-bit)
## Running under: Windows 8 x64 (build 9200)
## 
## locale:
## [1] LC_COLLATE=German_Germany.1252  LC_CTYPE=German_Germany.1252   
## [3] LC_MONETARY=German_Germany.1252 LC_NUMERIC=C                   
## [5] LC_TIME=German_Germany.1252    
## 
## attached base packages:
## [1] methods   stats     graphics  grDevices utils     datasets  base     
## 
## other attached packages:
## [1] reshape2_1.4.1    foreign_0.8-65    magrittr_1.5      stringr_1.0.0    
## [5] lubridate_1.3.3   dplyr_0.4.2       plyr_1.8.3        idep_1.0.0.900229
## [9] knitr_1.10.5     
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_0.11.6          digest_0.6.8         assertthat_0.1       R6_2.1.0            
##  [5] DBI_0.3.1            formatR_1.2          evaluate_0.7         highr_0.5           
##  [9] stringi_0.5-5        lazyeval_0.1.10.9000 tools_3.2.1          parallel_3.2.1      
## [13] memoise_0.2.1
</pre></div>
<div class="source"><pre class="knitr r">    <span class="hl kwd">Sys.time</span><span class="hl std">()</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] &quot;2015-08-04 15:02:05 CEST&quot;
</pre></div>
</div></div>


</body>
</html>
